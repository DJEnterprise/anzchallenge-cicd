node {
     
     properties([parameters([string(defaultValue: '621255284514.dkr.ecr.ap-southeast-2.amazonaws.com', name: 'DOCKER_REPO_URL', trim: true), 
                             string(defaultValue: 'mydockerrepo', name: 'DOCKER_IMAGE_NAME', trim: true)])])
        
        def git_commit_hash = ''
        def docker_image_status = 0
   
        echo 'Building ANZ Challenge App!' 
            
            stage('Get Docker Image Version'){
                deleteDir()
                checkout([$class: 'GitSCM', branches:[[name: "master"]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: "https://github.com/DJEnterprise/anzchallenge.git"]]])    
                git_commit_hash = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                echo "Docker Image Version ${DOCKER_IMAGE_NAME}:${git_commit_hash}"
                sh """
                aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin ${DOCKER_REPO_URL}
                """
                docker_image_status = sh(script: """docker pull ${DOCKER_REPO_URL}/${DOCKER_IMAGE_NAME}:${git_commit_hash} > /dev/null && echo 1|| echo 0""", returnStdout: true).trim()
            }

        if(docker_image_status == '0'){
            stage('Code Scan by SonarQube'){
            try {
            withSonarQubeEnv(credentialsId: 'sonarqube') { 
             sh './gradlew -Dsonar.host.url=http://localhost:9000 sonarqube'
                }
            }
            catch (Exception e) {
                echo "SonarQube not configured. Make sure Sonarqube server is running and token is congigured. Skipping Code Analysis for this build."
                }
            }

            stage('Build Code'){
                sh """ 
                ./gradlew build
                """
                }
            stage('Docker Build and Push to Repo'){
                sh """
                aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin ${DOCKER_REPO_URL}
                docker build -t ${DOCKER_IMAGE_NAME}:${git_commit_hash} .
                docker tag ${DOCKER_IMAGE_NAME}:${git_commit_hash} ${DOCKER_REPO_URL}/${DOCKER_IMAGE_NAME}:${git_commit_hash}
                docker push ${DOCKER_REPO_URL}/${DOCKER_IMAGE_NAME}:${git_commit_hash}
                """
                }
            
        }else {
            echo "Docker Image Already exist for commit ${git_commit_hash}"
        }
}
    
